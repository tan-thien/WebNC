@model WebShopSolution.ViewModels.Catalog.Product.ProductCreateViewModel

@{
    ViewData["Title"] = "Tạo sản phẩm";
}

<h2>Create Product</h2>

<form asp-action="Create" method="post" enctype="multipart/form-data">
    <div class="form-group">
        <label asp-for="ProductName"></label>
        <input asp-for="ProductName" class="form-control" />
        <span asp-validation-for="ProductName" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="Description"></label>
        <textarea asp-for="Description" class="form-control"></textarea>
        <span asp-validation-for="Description" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="IsVariantProduct"></label>
        <input asp-for="IsVariantProduct" type="checkbox" class="form-check-input" id="isVariantCheckbox" />
        <span asp-validation-for="IsVariantProduct" class="text-danger"></span>
    </div>

    <div id="variantSection" style="display:none; margin-top: 20px;">
        <h4>Product Variants</h4>

        <div id="variantList">
            <!-- Biến thể đầu tiên mặc định -->
        </div>

        <!-- Template ẩn để clone -->
        <div class="variant-item border rounded p-2 mb-2 d-none" id="variantTemplate">
            <div class="form-group">
                <label>SKU</label>
                <input type="text" class="form-control sku-input" />
            </div>
            <div class="form-group">
                <label>Price</label>
                <input type="number" step="0.01" class="form-control price-input" />
            </div>
            <div class="form-group">
                <label>Stock</label>
                <input type="number" class="form-control stock-input" />
            </div>
            <div class="form-group">
                <label>Status</label>
                <select class="form-control status-select">
                    <option value="Active">Active</option>
                    <option value="Inactive">Inactive</option>
                </select>
            </div>
            <div class="form-group">
                <label>Attributes</label>
                <div class="attribute-group">
                    <div class="d-flex mb-2">
                        <input type="text" class="form-control me-2 attr-name" placeholder="Attribute Name" />
                        <input type="text" class="form-control me-2 attr-value" placeholder="Attribute Value" />
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeAttribute(this)">×</button>
                    </div>
                </div>
                <button type="button" class="btn btn-secondary btn-sm mt-1" onclick="addAttribute(this)">+ Add Attribute</button>
            </div>
            <button type="button" class="btn btn-danger btn-sm mt-2" onclick="removeVariant(this)">× Remove Variant</button>
        </div>

        <button type="button" class="btn btn-primary btn-sm mt-2" onclick="addVariant()">+ Add Variant</button>
    </div>

    <div class="form-group">
        <label asp-for="BasePrice"></label>
        <input asp-for="BasePrice" class="form-control" />
        <span asp-validation-for="BasePrice" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="Quantity"></label>
        <input asp-for="Quantity" class="form-control" />
        <span asp-validation-for="Quantity" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="IdCate">Category</label>
        <select asp-for="IdCate" asp-items="ViewBag.Categories" class="form-control">
            <option value="">-- Select Category --</option>
        </select>
        <span asp-validation-for="IdCate" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="Status"></label>
        <select asp-for="Status" class="form-control">
            <option value="">-- Select status --</option>
            <option value="Active">Active</option>
            <option value="Inactive">Inactive</option>
        </select>
        <span asp-validation-for="Status" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label>Upload Images</label>
        <input type="file" name="Images" id="imageUpload" multiple class="form-control" />
    </div>

    <div id="imagePreview" class="d-flex flex-wrap gap-2 mt-2"></div>

    <button type="submit" class="btn btn-primary">Create</button>
    <a asp-action="Index" class="btn btn-secondary">Back to List</a>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        let variantIndex = 0;

        function addVariant() {
            const template = document.getElementById('variantTemplate');
            const clone = template.cloneNode(true);
            clone.classList.remove('d-none');

            // Gán lại name cho các input chính
            clone.querySelector('.sku-input').name = `Variants[${variantIndex}].Sku`;
            clone.querySelector('.price-input').name = `Variants[${variantIndex}].Price`;
            clone.querySelector('.stock-input').name = `Variants[${variantIndex}].Stock`;
            clone.querySelector('.status-select').name = `Variants[${variantIndex}].Status`;

            // Gán lại name cho input attribute đầu tiên
            const attrGroup = clone.querySelector('.attribute-group');
            attrGroup.innerHTML = `
                <div class="d-flex mb-2">
                    <input type="text" name="Variants[${variantIndex}].AttributeNames[0]" class="form-control me-2" placeholder="Attribute Name" />
                    <input type="text" name="Variants[${variantIndex}].AttributeValues[0]" class="form-control me-2" placeholder="Attribute Value" />
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeAttribute(this)">×</button>
                </div>
            `;

            document.getElementById('variantList').appendChild(clone);
            variantIndex++;
        }


        function removeVariant(btn) {
            const item = btn.closest('.variant-item');
            item.remove();
        }

        function addAttribute(btn) {
            const variantItem = btn.closest('.variant-item');
            const group = btn.previousElementSibling;

            const nameInput = variantItem.querySelector('input[name^="Variants["]');
            if (!nameInput) return;

            const variantIdx = nameInput.name.match(/Variants\[(\d+)\]/)[1];
            const attrCount = group.querySelectorAll('input[name*="AttributeNames"]').length;

            const div = document.createElement("div");
            div.className = "d-flex mb-2";
            div.innerHTML = `
                <input type="text" name="Variants[${variantIdx}].AttributeNames[${attrCount}]" class="form-control me-2" placeholder="Attribute Name" />
                <input type="text" name="Variants[${variantIdx}].AttributeValues[${attrCount}]" class="form-control me-2" placeholder="Attribute Value" />
                <button type="button" class="btn btn-danger btn-sm" onclick="removeAttribute(this)">×</button>
            `;
            group.appendChild(div);
        }


        function removeAttribute(btn) {
            btn.parentElement.remove();
        }

        document.getElementById("isVariantCheckbox").addEventListener("change", function () {
            const section = document.getElementById("variantSection");
            section.style.display = this.checked ? "block" : "none";
        });

        // Image preview
        const input = document.getElementById('imageUpload');
        const preview = document.getElementById('imagePreview');
        const filesArray = [];

        input.addEventListener('change', function () {
            preview.innerHTML = '';
            filesArray.length = 0;
            for (let i = 0; i < input.files.length; i++) {
                filesArray.push(input.files[i]);
            }
            updatePreview();
        });

        function updatePreview() {
            preview.innerHTML = '';
            filesArray.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const div = document.createElement('div');
                    div.classList.add('position-relative');

                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.classList.add('rounded', 'border');
                    img.style.width = '150px';
                    img.style.height = '150px';
                    img.style.objectFit = 'cover';
                    img.style.margin = '5px';

                    const btn = document.createElement('button');
                    btn.innerText = '×';
                    btn.type = 'button';
                    btn.classList.add('btn', 'btn-sm', 'btn-danger', 'position-absolute');
                    btn.style.top = '0';
                    btn.style.right = '0';
                    btn.onclick = function () {
                        filesArray.splice(index, 1);
                        updateInputFiles();
                        updatePreview();
                    };

                    div.appendChild(img);
                    div.appendChild(btn);
                    preview.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        }

        function updateInputFiles() {
            const dataTransfer = new DataTransfer();
            filesArray.forEach(file => dataTransfer.items.add(file));
            input.files = dataTransfer.files;
        }

        // Gọi mặc định thêm 1 biến thể đầu tiên
        window.addEventListener('DOMContentLoaded', function () {
            addVariant();
        });
    </script>
}
