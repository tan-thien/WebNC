@model WebShopSolution.ViewModels.Catalog.Order.OrderCreateRequest

@{
    ViewData["Title"] = "Thanh toán";
    var isOrderSuccess = TempData["OrderSuccess"] != null && (bool)TempData["OrderSuccess"] == true;
    var hasVoucher = !string.IsNullOrWhiteSpace(Model.VoucherCode);
    var hasDiscount = Model.DiscountAmount > 0;
}

<h2 class="page-title text-center">
    <i class="bi bi-credit-card-2-front-fill me-2 text-primary"></i> @ViewData["Title"]
</h2>


<h4 class="checkout-heading"><i class="bi bi-bag-check-fill"></i> Danh sách sản phẩm</h4>
<div class="section-box">
    <table class="table table-bordered table-hover table-checkout">
        <thead class="table-light text-center">
            <tr>
                <th>Hình ảnh</th>
                <th>Tên sản phẩm</th>
                <th>Biến thể</th>
                <th>Số lượng</th>
                <th>Giá</th>
                <th>Thành tiền</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model.Items)
            {
                <tr>
                    <td class="text-center"><img src="@item.ImagePath" width="60" /></td>
                    <td>@item.ProductName</td>
                    <td>@(string.IsNullOrEmpty(item.VariantInfo) ? "-" : item.VariantInfo)</td>
                    <td>@item.Quantity</td>
                    <td>@String.Format("{0:N0} đ", item.Price)</td>
                    <td>@String.Format("{0:N0} đ", item.Price * item.Quantity)</td>
                </tr>
            }
        </tbody>
    </table>
</div>


<!-- Tổng tiền -->
<div id="discount-summary" class="total-summary text-end section-box">
    @if (hasDiscount)
    {
        <h5>Tạm tính: <span>@String.Format("{0:N0} đ", Model.TotalAmount)</span></h5>
        <h5 class="text-success">Giảm giá: -@String.Format("{0:N0} đ", Model.DiscountAmount)</h5>
        <h4 class="text-danger">💰 Tổng tiền: @String.Format("{0:N0} đ", Model.TotalAmount - Model.DiscountAmount)</h4>
    }
    else
    {
        <h4 class="text-danger">💰 Tổng tiền: @String.Format("{0:N0} đ", Model.TotalAmount)</h4>
    }
</div>



<form asp-action="Checkout" method="post">
    <input type="hidden" asp-for="ShippingAddress" />
    <input type="hidden" asp-for="Phone" />
    <input type="hidden" asp-for="TotalAmount" />
    <input type="hidden" asp-for="DiscountAmount" />
    <input type="hidden" asp-for="IsVoucherFromCart" />

    <h4 class="checkout-heading mt-5"><i class="bi bi-truck"></i> Thông tin giao hàng</h4>
    <div class="section-box">
        <div class="mb-2">
            <strong>Địa chỉ:</strong>
            <p>@Model.ShippingAddress</p>
        </div>
        <div class="mb-2">
            <strong>Số điện thoại:</strong>
            <p>@Model.Phone</p>
        </div>
    </div>


    <!-- Mã khuyến mãi -->
    <h4 class="checkout-heading"><i class="bi bi-gift"></i> Mã khuyến mãi</h4>
    <div class="section-box">
    @if (Model.IsVoucherFromCart)
    {
        <div class="alert alert-info">
            <strong>Mã đã áp dụng từ giỏ hàng:</strong> @Model.VoucherCode
        </div>
        <input type="hidden" asp-for="VoucherCode" />
    }
    else if (hasVoucher)
    {
        <div class="alert alert-info">
            <strong>Mã đã áp dụng:</strong> @Model.VoucherCode
        </div>
        <input type="hidden" asp-for="VoucherCode" />
    }
    else
    {
        <div class="input-group mb-3" style="max-width: 400px;">
            <input type="text" class="form-control" id="voucherInput" name="VoucherCode" placeholder="Nhập mã giảm giá" />
            <button type="button" class="btn btn-outline-primary" id="applyVoucherBtn">Áp dụng</button>
        </div>
    }
    </div>

    <!-- Hidden sản phẩm -->
    @for (int i = 0; i < Model.Items.Count; i++)
    {
        <input type="hidden" name="Items[@i].ProductId" value="@Model.Items[i].ProductId" />
        <input type="hidden" name="Items[@i].VariantId" value="@Model.Items[i].VariantId" />
        <input type="hidden" name="Items[@i].Quantity" value="@Model.Items[i].Quantity" />
        <input type="hidden" name="Items[@i].Price" value="@Model.Items[i].Price" />
        <input type="hidden" name="Items[@i].ProductName" value="@Model.Items[i].ProductName" />
        <input type="hidden" name="Items[@i].ImagePath" value="@Model.Items[i].ImagePath" />
        <input type="hidden" name="Items[@i].VariantInfo" value="@Model.Items[i].VariantInfo" />
    }

    <!-- Nút xác nhận đặt hàng -->
    <div class="text-center mt-4">
        <button type="submit" class="btn btn-primary btn-lg shadow-sm px-4 py-2 rounded-3 d-inline-flex align-items-center gap-2">
            <i class="bi bi-bag-check-fill fs-5"></i> Đặt hàng
        </button>
    </div>
</form>
<hr />
<h4 class="text-center">— Hoặc thanh toán bằng —</h4>
<hr />

<form id="paypalForm" asp-controller="Order" asp-action="PayWithPayPal" method="post">
    @* Các trường ẩn *@
    <input type="hidden" name="ShippingAddress" value="@Model.ShippingAddress" />
    <input type="hidden" name="Phone" value="@Model.Phone" />
    <input type="hidden" name="TotalAmount" value="@Model.TotalAmount" />
    <input type="hidden" name="DiscountAmount" value="@Model.DiscountAmount" />
    <input type="hidden" name="VoucherCode" value="@Model.VoucherCode" />
    <input type="hidden" name="IsVoucherFromCart" value="@Model.IsVoucherFromCart" />

    @for (int i = 0; i < Model.Items.Count; i++)
    {
        <input type="hidden" name="Items[@i].ProductId" value="@Model.Items[i].ProductId" />
        <input type="hidden" name="Items[@i].VariantId" value="@Model.Items[i].VariantId" />
        <input type="hidden" name="Items[@i].Quantity" value="@Model.Items[i].Quantity" />
        <input type="hidden" name="Items[@i].Price" value="@Model.Items[i].Price" />
        <input type="hidden" name="Items[@i].ProductName" value="@Model.Items[i].ProductName" />
        <input type="hidden" name="Items[@i].ImagePath" value="@Model.Items[i].ImagePath" />
        <input type="hidden" name="Items[@i].VariantInfo" value="@Model.Items[i].VariantInfo" />
    }

    <!-- Nút PayPal -->
    <div class="text-center mt-4">
        <button type="submit" class="btn btn-outline-warning btn-lg shadow-sm px-4 py-2 rounded-3 d-inline-flex align-items-center gap-2">
            <i class="fab fa-paypal fs-5"></i> Thanh toán bằng PayPal
        </button>
        <p class="paypal-note mt-2">💵 Bạn sẽ được chuyển sang PayPal để thanh toán bằng USD (đã quy đổi từ VND).</p>
    </div>

</form>



<style>
    .page-title {
        font-size: 2rem;
        font-weight: 700;
        color: #17479D;
        margin-bottom: 30px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
    }

        .page-title i {
            font-size: 1.8rem;
        }
    .section-box {
        background-color: #f9f9f9;
        border: 1px solid #e0e0e0;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 30px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }

    .checkout-heading {
        font-weight: 600;
        margin-bottom: 15px;
        color: #17479D;
        display: flex;
        align-items: center;
        gap: 10px;
    }

        .checkout-heading i {
            color: #ee6823;
        }

    .total-summary h4,
    .total-summary h5 {
        margin-bottom: 8px;
    }

        .total-summary h4.text-danger {
            font-weight: bold;
        }

    .paypal-note {
        font-size: 0.95rem;
        color: #dc3545;
    }

    .voucher-applied {
        font-size: 0.95rem;
        color: #198754;
    }

    .table-checkout th,
    .table-checkout td {
        vertical-align: middle !important;
    }

    .table-checkout img {
        border-radius: 8px;
        border: 1px solid #ddd;
    }


    .btn {
        transition: all 0.3s ease-in-out;
    }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
        }

    .btn-outline-warning {
        border-color: #ffc107;
        color: #ffc107;
        background-color: white;
    }

        .btn-outline-warning:hover {
            background-color: #ffc107;
            color: white;
        }

</style>



@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        const isOrderSuccess = @(isOrderSuccess.ToString().ToLower());

        if (isOrderSuccess) {
            Swal.fire({
                icon: 'success',
                title: '🎉 Đặt hàng thành công!',
                html: 'Bạn sẽ được chuyển về trang chủ sau <b id="countdown">4</b> giây...',
                showConfirmButton: false,
                allowOutsideClick: false,
                allowEscapeKey: false,
                didOpen: () => {
                    let seconds = 4;
                    const countdownEl = Swal.getHtmlContainer().querySelector('#countdown');

                    const countdown = setInterval(() => {
                        seconds--;
                        countdownEl.textContent = seconds;

                        if (seconds <= 0) {
                            clearInterval(countdown);
                            window.location.href = '/Home/Index';
                        }
                    }, 1000);
                }
            });
        }

        // Xử lý nút áp dụng mã giảm giá
        document.getElementById("applyVoucherBtn")?.addEventListener("click", async () => {
            const input = document.getElementById("voucherInput");
            const voucherCode = input?.value?.trim();

            if (!voucherCode) {
                Swal.fire("Lỗi", "Vui lòng nhập mã giảm giá.", "warning");
                return;
            }

            const response = await fetch("/Order/ApplyVoucher", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ voucherCode })
            });

            const result = await response.json();
            if (result.success) {
                document.getElementById("discount-summary").innerHTML = `
                    <h5 class="text-end">Tạm tính: ${result.originalTotal.toLocaleString()} đ</h5>
                    <h5 class="text-end text-success">Giảm giá: -${result.discountAmount.toLocaleString()} đ</h5>
                    <h4 class="text-end text-danger">Tổng tiền: ${(result.originalTotal - result.discountAmount).toLocaleString()} đ</h4>
                `;

                document.getElementById("voucherInput").disabled = true;
                document.getElementById("applyVoucherBtn").disabled = true;

                const hiddenVoucher = document.createElement("input");
                hiddenVoucher.type = "hidden";
                hiddenVoucher.name = "VoucherCode";
                hiddenVoucher.value = voucherCode;
                document.querySelector("form").appendChild(hiddenVoucher);

                const discountHidden = document.createElement("input");
                discountHidden.type = "hidden";
                discountHidden.name = "DiscountAmount";
                discountHidden.value = result.discountAmount;
                document.querySelector("form").appendChild(discountHidden);
            } else {
                Swal.fire("Không hợp lệ", result.message, "error");
            }
        });
    </script>
}
